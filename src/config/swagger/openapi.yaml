openapi: 3.1.0
info:
  title: Report Document Generation API
  version: 1.0.0
  description: API for managing cybersecurity report templates (Express + TypeScript + Mongoose)

servers:
  - url: http://localhost:3000/api
    description: Local API

paths:
  ###################################
  ## BLUEPRINT ROUTES
  ###################################

  /blueprints:
    get:
      summary: List of all blueprints
      tags: [Blueprints]
      responses:
        '200':
          description: List all blueprints
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Blueprint'
        '500':
          description: Internal error

    post:
      summary: Create a blueprint
      tags: [Blueprints]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBlueprintBody'
      responses:
        '201':
          description: Created blueprint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Blueprint'
        '400':
          description: Zod Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZodValidationError'
        '500':
          description: Internal error

  /blueprints/{id}:
    get:
      summary: Get blueprint by ID
      tags: [Blueprints]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Blueprint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Blueprint'
        '404':
          description: Blueprint not found
        '500':
          description: Internal error

    patch:
      summary: Update a blueprint
      tags: [Blueprints]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBlueprintBody'
      responses:
        '200':
          description: Updated blueprint
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Blueprint'
        '400':
          description: Zod Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZodValidationError'
        '404':
          description: Blueprint not found
        '500':
          description: Internal error

    delete:
      summary: Delete a blueprint
      tags: [Blueprints]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          description: Blueprint not found
        '500':
          description: Internal error

  ###################################
  ## TEMPLATE ROUTES
  ###################################

  /templates:
    get:
      summary: list of all templates
      tags: [Templates]
      responses:
        '200':
          description: List all templates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Template'
        '500':
          description: Internal error

    post:
      summary: Create a template
      tags: [Templates]
      description: Upload file and Template metaData
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                ######################################################################################################
                ## Swagger seems to have limitation when it comes to display nested data object in multipart/form-data
                ######################################################################################################
                data:
                  type: object
                  contentSchema:
                    $ref: '#/components/schemas/CreateTemplateBody'
      responses:
        '201':
          description: Created Template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          description: Zod Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZodValidationError'
        '404':
          description: Blueprint not found
        '500':
          description: Internal error

  /templates/{id}:
    get:
      summary: Get template by ID
      tags: [Templates]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '404':
          description: Template not found
        '500':
          description: Internal error

    patch:
      summary: Update a template
      tags: [Templates]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                ######################################################################################################
                ## Swagger seems to have limitation when it comes to display nested data object in multipart/form-data
                ######################################################################################################
                data:
                  type: object
                  contentSchema:
                    $ref: '#/components/schemas/UpdateTemplateBody'
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Updated template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Template'
        '400':
          description: Zod Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZodValidationError'
        '500':
          description: Internal error

    delete:
      summary: Delete a template
      tags: [Templates]
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Deleted
        '404':
          description: Template introuvable
        '500':
          description: Internal error

components:
  ###################################
  ## PARAMETERS
  ###################################
  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string
        description: MongoDB ObjectID

  ###################################
  ## SCHEMAS
  ###################################
  schemas:
    ###################################
    ## BLUEPRINT SCHEMAS
    ###################################
    Blueprint:
      type: object
      properties:
        _id:
          type: string
        name:
          type: string
        description:
          type: string
        data_structure:
          type: object
          description: 'Key â†’ type'
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateBlueprintBody:
      type: object
      required:
        - name
        - data_structure
      properties:
        name:
          type: string
        description:
          type: string
        data_structure:
          type: object
          additionalProperties: true

    UpdateBlueprintBody:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        data_structure:
          type: object
          additionalProperties: true

    ###################################
    ## TEMPLATE SCHEMAS
    ###################################
    Template:
      type: object
      properties:
        _id:
          type: string
        blueprint_id:
          type: string
        filename:
          type: string
        name:
          type: string
        default:
          type: boolean
        format:
          type: string
        supported_output_formats:
          type: array
          items:
            type: string
        language:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateTemplateBody:
      type: object
      required:
        - blueprint_id
        - name
        - language
      properties:
        blueprint_id:
          type: string
        name:
          type: string
        default:
          type: boolean
        language:
          type: string

    UpdateTemplateBody:
      type: object
      properties:
        name:
          type: string
        default:
          type: boolean
        language:
          type: string

    ###################################
    ## ZOD VALIDATION ERROR SCHEMAS
    ###################################
    ZodValidationError:
      type: object
      properties:
        message:
          type: string
          example: 'Validation error'
        errors:
          type: array
          items:
            type: object
            properties:
              path:
                type: array
                description: Path to the invalid field
                items:
                  type: string
                example: ['data', 'name']
              message:
                type: string
                example: 'Name is required'
              code:
                type: string
                example: 'invalid_type'
